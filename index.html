<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mini Virtual DOM</title>
  </head>
  <body>
    <div id="root"></div>

    <script>
      // สร้าง Virtual DOM node
      function h(type, props, ...children) {
        return { type, props: props || {}, children };
      }

      // สร้าง DOM จริงจาก VDOM
      function createElement(vnode) {
        if (typeof vnode === "string") {
          return document.createTextNode(vnode);
        }

        const el = document.createElement(vnode.type);

        for (let [key, value] of Object.entries(vnode.props || {})) {
          el.setAttribute(key, value);
        }

        vnode.children.forEach(child => {
          el.appendChild(createElement(child));
        });

        return el;
      }

      // เปรียบเทียบและอัปเดต DOM
      function updateElement(parent, newNode, oldNode, index = 0) {
        const existing = parent.childNodes[index];

        if (!newNode && oldNode && existing) {
          parent.removeChild(existing);
          return;
        }

        if (newNode && !oldNode) {
          parent.appendChild(createElement(newNode));
          return;
        }

        if (
          typeof newNode !== typeof oldNode ||
          (typeof newNode !== "string" && newNode.type !== oldNode.type)
        ) {
          parent.replaceChild(createElement(newNode), existing);
          return;
        }

        if (typeof newNode === "string" && newNode !== oldNode) {
          existing.nodeValue = newNode;
          return;
        }

        const newProps = newNode.props || {};
        const oldProps = oldNode.props || {};

        for (let [key, value] of Object.entries(newProps)) {
          if (value !== oldProps[key]) {
            existing.setAttribute(key, value);
          }
        }

        for (let key in oldProps) {
          if (!(key in newProps)) {
            existing.removeAttribute(key);
          }
        }

        // ถ้ามีลูก และเป็น Element node
        if (existing.nodeType === Node.ELEMENT_NODE) {
          const maxLen = Math.max(
            newNode.children.length,
            oldNode.children.length
          );

          for (let i = 0; i < maxLen; i++) {
            updateElement(
              existing,
              newNode.children[i],
              oldNode.children[i],
              i
            );
          }
        }
      }

      // Initial VDOM
      let vOld = h("div", { id: "app" },
        h("h1", null, "Hello"),
        h("p", null, "Virtual DOM")
      );

      const root = document.getElementById("root");
      const dom = createElement(vOld);
      root.appendChild(dom); // render แรก

      // เปลี่ยนหลัง 2 วิ
      setTimeout(() => {
        const vNew = h("div", { id: "app" },
          h("h1", null, "Hi!"),
          h("p", null, "Updated VDOM"),
          h("small", null, "New line")
        );

        updateElement(root, vNew, vOld);
        vOld = vNew;
      }, 2000);
    </script>
  </body>
</html>
